#!/bin/bash
set -e

# The installer runs as root, so $HOME may not be the userâ€™s home.
# We'll detect the logged-in user to run build.sh in their context.
USER_NAME=$(stat -f "%Su" /dev/console)
USER_HOME=$(dscl . -read /Users/$USER_NAME NFSHomeDirectory | awk '{print $2}')

echo "Running build.sh as $USER_NAME..."

# Make sure build.sh is executable
chmod +x "$INSTALLER_TEMP/build.sh" 2>/dev/null || chmod +x "/tmp/build.sh" 2>/dev/null || true
chmod +x "$(dirname "$0")/../build.sh" 2>/dev/null || true

# Run build.sh as the logged-in user (not root)
su - "$USER_NAME" -c "bash \"$(dirname \"$0\")/../build.sh\""

exit 0
