#!/bin/bash

# -------------------------------
# Postinstall script for naps2
# -------------------------------

LOG_FILE="/tmp/naps2-postinstall.log"
BUILD_SCRIPT="/usr/local/naps2-service/build.sh"

# Ensure the log exists and is writable
touch "$LOG_FILE"
chmod 666 "$LOG_FILE"

echo "=== Postinstall started at $(/bin/date) ===" >> "$LOG_FILE"
echo "Script running as user: $(whoami)" >> "$LOG_FILE"
echo "Working directory: $(pwd)" >> "$LOG_FILE"
echo "Environment PATH: $PATH" >> "$LOG_FILE"

# -------------------------------
# Run build.sh safely
# -------------------------------

if [ -f "$BUILD_SCRIPT" ]; then
    # Make sure it's executable
    /bin/chmod +x "$BUILD_SCRIPT"

    echo "Running build.sh..." >> "$LOG_FILE"

    # Run build.sh and log all output, but prevent installer failure
    /bin/bash "$BUILD_SCRIPT" >> "$LOG_FILE" 2>&1 || echo "⚠️ build.sh failed, check log" >> "$LOG_FILE"

else
    echo "❌ build.sh not found at $BUILD_SCRIPT" >> "$LOG_FILE"
fi

echo "=== Postinstall finished at $(/bin/date) ===" >> "$LOG_FILE"

# Always exit 0 so installer does not fail
exit 0
