#!/bin/bash

LOG_FILE="/tmp/naps2-postinstall.log"
SERVICE_NAME="naps2-service"
SERVICE_PATH="/usr/local/$SERVICE_NAME"
BUILD_SCRIPT="$SERVICE_PATH/build.sh"
USER_NAME="${SUDO_USER:-$USER}"
USER_ID=$(id -u "$USER_NAME")
USER_HOME=$(eval echo "~$USER_NAME")

touch "$LOG_FILE"
chmod 666 "$LOG_FILE"

{
  echo "=== Postinstall started at $(date) ==="
  echo "Running as $(whoami)"
  echo "User context: $USER_NAME ($USER_ID)"
  echo "-----------------------------------------"

  echo "→ Stopping running service..."
  launchctl stop com.$SERVICE_NAME 2>/dev/null || true
  launchctl bootout gui/$USER_ID "$USER_HOME/Library/LaunchAgents/com.$SERVICE_NAME.plist" 2>/dev/null || true
  pkill -f "$SERVICE_NAME" 2>/dev/null || true

  echo "→ Cleaning old installation..."
  rm -f "$USER_HOME/Library/LaunchAgents/com.$SERVICE_NAME.plist" 2>/dev/null || true
  rm -rf "$USER_HOME/Desktop/NAPS2 Service.app" 2>/dev/null || true
  sudo rm -f /Library/LaunchAgents/com.$SERVICE_NAME.plist 2>/dev/null || true
  sudo rm -f /Library/LaunchDaemons/com.$SERVICE_NAME.plist 2>/dev/null || true
  echo "✅ Old service cleaned up"
  echo "-----------------------------------------"

  echo "→ Waiting for new payload to be ready..."
  for i in {1..20}; do
    if [ -f "$BUILD_SCRIPT" ]; then
      echo "✅ Found build.sh at $BUILD_SCRIPT"
      break
    fi
    sleep 0.5
  done

  if [ ! -f "$BUILD_SCRIPT" ]; then
    echo "❌ build.sh not found after waiting. Check your pkg payload."
  else
    chmod +x "$BUILD_SCRIPT"
    echo "→ Running build.sh..."
    /bin/bash "$BUILD_SCRIPT" >> "$LOG_FILE" 2>&1 || echo "⚠️ build.sh execution failed"
  fi

  PLIST_PATH="$USER_HOME/Library/LaunchAgents/com.$SERVICE_NAME.plist"
  if [ -f "$PLIST_PATH" ]; then
    echo "→ Loading new LaunchAgent..."
    sudo -u "$USER_NAME" launchctl bootstrap gui/$USER_ID "$PLIST_PATH" 2>/dev/null || true
    sudo -u "$USER_NAME" launchctl kickstart -k gui/$USER_ID/com.$SERVICE_NAME 2>/dev/null || true
    echo "✅ Service started successfully"
  else
    echo "⚠️ LaunchAgent not found after build"
  fi

  echo "=== Postinstall finished at $(date) ==="
} >> "$LOG_FILE" 2>&1

exit 0
